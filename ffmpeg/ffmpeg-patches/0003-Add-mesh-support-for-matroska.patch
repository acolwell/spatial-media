From fe6bc25afd2e940e6301359e87e1fa85332c23d2 Mon Sep 17 00:00:00 2001
From: Aaron Colwell <acolwell@google.com>
Date: Sat, 30 Sep 2017 14:35:48 -0700
Subject: [PATCH] Add mesh support for matroska.

---
 libavformat/matroskadec.c | 20 ++++++++++++++++----
 libavformat/matroskaenc.c |  6 ++++++
 2 files changed, 22 insertions(+), 4 deletions(-)

diff --git a/libavformat/matroskadec.c b/libavformat/matroskadec.c
index 158ce7ae1f..f48879ff47 100644
--- a/libavformat/matroskadec.c
+++ b/libavformat/matroskadec.c
@@ -1928,7 +1928,7 @@ static int mkv_parse_video_color(AVStream *st, const MatroskaTrack *track) {
 }
 
 static int mkv_parse_video_projection(AVStream *st, const MatroskaTrack *track) {
-    AVSphericalMapping *spherical;
+    AVSphericalMapping *spherical = NULL;
     enum AVSphericalProjection projection;
     size_t spherical_size;
     uint32_t l = 0, t = 0, r = 0, b = 0;
@@ -1992,6 +1992,16 @@ static int mkv_parse_video_projection(AVStream *st, const MatroskaTrack *track)
     case MATROSKA_VIDEO_PROJECTION_TYPE_RECTANGULAR:
         /* No Spherical metadata */
         return 0;
+    case MATROSKA_VIDEO_PROJECTION_TYPE_MESH:
+        spherical_size = sizeof(AVSphericalMapping) + track->video.projection.private.size;
+        spherical = av_mallocz(spherical_size);
+        if (!spherical)
+            return AVERROR(ENOMEM);
+        projection = AV_SPHERICAL_MESH;
+        memcpy(spherical->mesh_data, track->video.projection.private.data,
+               track->video.projection.private.size);
+        spherical->mesh_size = track->video.projection.private.size;
+        break;
     default:
         av_log(NULL, AV_LOG_WARNING,
                "Unknown spherical metadata type %"PRIu64"\n",
@@ -1999,9 +2009,11 @@ static int mkv_parse_video_projection(AVStream *st, const MatroskaTrack *track)
         return 0;
     }
 
-    spherical = av_spherical_alloc(&spherical_size);
-    if (!spherical)
-        return AVERROR(ENOMEM);
+    if (!spherical) {
+        spherical = av_spherical_alloc(&spherical_size);
+        if (!spherical)
+            return AVERROR(ENOMEM);
+    }
 
     spherical->projection = projection;
 
diff --git a/libavformat/matroskaenc.c b/libavformat/matroskaenc.c
index f22c2ab70c..49766ff18a 100644
--- a/libavformat/matroskaenc.c
+++ b/libavformat/matroskaenc.c
@@ -1001,6 +1001,12 @@ static int mkv_write_video_projection(AVFormatContext *s, AVIOContext *pb,
         put_ebml_binary(dyn_cp, MATROSKA_ID_VIDEOPROJECTIONPRIVATE,
                         private, avio_tell(&b));
         break;
+    case AV_SPHERICAL_MESH:
+        put_ebml_uint(dyn_cp, MATROSKA_ID_VIDEOPROJECTIONTYPE,
+                      MATROSKA_VIDEO_PROJECTION_TYPE_MESH);
+        put_ebml_binary(dyn_cp, MATROSKA_ID_VIDEOPROJECTIONPRIVATE,
+                        spherical->mesh_data, spherical->mesh_size);
+        break;
     default:
         av_log(s, AV_LOG_WARNING, "Unknown projection type\n");
         goto end;
-- 
2.7.4

